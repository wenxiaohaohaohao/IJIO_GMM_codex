# 工作区权限管理方案

## 问题描述

代码运行过程中遇到文件删除限制，导致涉及文件替换（replace）的代码无法正常运行。

## 脚本文件位置

所有权限管理脚本已存放在以下位置：

```
workflow/tools/
├── reset_permissions_comprehensive.ps1    # 解除中间产物的删除限制
├── protect_original_data.ps1             # 保护原始数据为只读
└── verify_permissions.ps1                # 验证权限配置是否正确
```

## 解决方案

已经执行的操作：

### 1. 解除中间产物的删除限制

脚本：`workflow/tools/reset_permissions_comprehensive.ps1`

- **扫描结果**：找到834个只读文件
- **处理结果**：全部成功解除只读限制（0失败）
- **影响范围**：
  - 所有日志文件（.log）
  - 中间生成的数据文件
  - 临时文件
  - results/ 和 data/work 目录中的文件
  - 图表目录中生成的文件

### 2. 保护原始数据

脚本：`workflow/tools/protect_original_data.ps1`

- **保护的原始数据**：3个文件
  - Brandt-Rawski investment deflator.dta
  - OLStariff_yu_style.dta
  - processing_vars_yu_style.dta

## 当前状态

✅ **完成**
- 中间产物已解除删除限制，代码可以正常进行文件替换和删除操作
- 原始数据已保护为只读，防止意外修改
- 工作区准备就绪，可以正常运行任何涉及文件操作的代码

## 代码风格建议

### 推荐统一使用 Replace 方式

既然权限已明确区分（原始数据只读，中间产物可删除），**建议代码统一使用 replace 方式**而不是 capture erase：

#### 优势：
1. **更直接高效** - Replace 直接替换文件内容，一步到位
2. **更清晰易读** - 代码意图明确，减少中间步骤
3. **更可靠** - 避免 capture erase 中可能的权限冲突
4. **更好维护** - 统一代码风格，便于理解和修改

#### 使用指南：

对于 **Stata 代码**，推荐模式：
```stata
* 使用 replace 替换中间产物（日志文件、生成的数据）
replace variable = new_value if condition

* 或使用 save 直接覆盖：
save filename, replace
```

对于 **中间产物文件**（.log, .dta, .csv等）：
- 直接使用 replace 参数覆盖
- 无需先 erase 再创建
- 权限限制已解除，可安心使用



### 如果遇到新的删除限制问题

1. **再次解除所有中间文件的限制**
   ```powershell
   powershell -ExecutionPolicy Bypass -File workflow\tools\reset_permissions_comprehensive.ps1
   ```

2. **确保原始数据仍然受保护**
   ```powershell
   powershell -ExecutionPolicy Bypass -File workflow\tools\protect_original_data.ps1
   ```

3. **验证权限配置是否正确**
   ```powershell
   powershell -ExecutionPolicy Bypass -File workflow\tools\verify_permissions.ps1
   ```

### 如果需要管理员权限

如果某些文件仍然无法被删除，可能需要以管理员身份运行：

1. 右键单击 PowerShell
2. 选择"以管理员身份运行"
3. 运行相应的脚本

## 文件区分标准

### 原始数据（保持只读）
- Brandt-Rawski investment deflator.dta
- OLStariff_yu_style.dta
- processing_vars_yu_style.dta
- 关税数据目录（guanshuishuju/）中的数据文件

### 中间产物（允许删除/修改）
- **firststage.dta** - 可被 replace 和删除
- **firststagecd.dta** - 可被 replace 和删除
- **firststagehicks.dta** - 可被 replace 和删除
- 日志文件（*.log）
- results/ 目录中的所有文件
- 图表/ 目录中生成的文件
- 临时工作文件
- git对象（.git/objects/）

## 注意事项

1. **风险已控制**：
   - 原始数据受到保护
   - 中间产物可以正常替换
   - 代码运行不会再遇到删除限制

2. **版本控制**：
   - 已有git repository，变更会被tracked
   - 重要变更建议提交

3. **定期维护**：
   - 如果工作区添加了新的中间产物，定期运行权限重置脚本
   - 保持原始数据保护脚本的更新

---

最后执行时间：2026年2月26日

## 关于脚本的说明

### 脚本功能概览

| 脚本文件 | 功能 | 何时使用 |
|---------|------|---------|
| `reset_permissions_comprehensive.ps1` | 扫描并解除所有中间产物的只读限制 | 代码遇到删除限制时 |
| `protect_original_data.ps1` | 为原始数据文件设置只读保护 | 初次设置或定期检查 |
| `verify_permissions.ps1` | 验证权限配置是否生效 | 操作完成后验证结果 |
| `remove_firststage_readonly.ps1` | 移除 firststage.dta 的只读属性 | 特定操作（已执行） |

### 脚本留存计划

这些脚本将保留到项目结束，以供以下用途：
- 权限问题的快速修复
- 新增中间产物时的权限管理
- 团队成员的权限问题排查

项目结束时可将整个 `workflow/tools/` 目录删除。

## 修改记录

### 2026-02-26 更新2
**变更**：将 `firststagecd.dta` 和 `firststagehicks.dta` 从原始数据保护列表中移除

**原因**：这两个文件都是中间产物，需要支持 replace 和删除操作，不应保持只读

**影响**：
- `firststagecd.dta` 和 `firststagehicks.dta` 现在可以被正常 replace 和删除
- 原始数据保护列表现在只有 3 个文件
- 代码可直接使用 replace 方式处理这些文件

**修改的文件**：
- `权限管理说明.md` - 更新文件分类标准
- `workflow/tools/protect_original_data.ps1` - 移除列表中的两个文件
- `firststagecd.dta` 和 `firststagehicks.dta` - 执行脚本移除只读属性

### 2026-02-26 更新1
**变更**：将 `firststage.dta` 从原始数据保护列表中移除

**原因**：`firststage.dta` 是中间产物，需要支持 replace 和删除操作，不应保持只读

**影响**：
- `firststage.dta` 现在可以被正常 replace 和删除
- 其他原始数据文件（5个）保持只读保护
- 代码可直接使用 replace 方式处理该文件

**修改的文件**：
- `权限管理说明.md` - 更新文件分类标准
- `workflow/tools/protect_original_data.ps1` - 移除列表中的 firststage.dta
- `firststage.dta` - 执行脚本移除只读属性
