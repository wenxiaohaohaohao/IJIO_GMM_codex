/*	Market Structure, Oligopsony Power, and Productivity			(Michael Rubens, UCLA)			- ACF production function -========================================================*/cd "D:\文章发表\欣昊\input markdown\IJIO\学习材料\rubens AER\186041-V1" set more offuse ./Data/china_tobacco_data, clearset matsize 11000    /* 1. Leaf market shares----------------------------*/  global share = 0.117647   // see nested logit filegen const = 1//drop lhs* forvalues m = 2(2)6 {bys dq`m'id yr: egen pop_lab_dq`m' = sum(pop_lab)bys dq`m'id yr: egen poptab_dq`m' = sum(q*$share)gen qshare_dq`m' = q*$share/pop_lab_dq`m'gen lqshare_dq`m' = log(qshare_dq`m')gen qshare_nest_dq`m' = q*$share/poptab_dq`m'gen lqshare_nest_dq`m' = log(qshare_nest_dq`m')gen oo_dq`m' = (pop_lab_dq`m'-poptab_dq`m')/pop_lab_dq`m'gen loo_dq`m' =  log(oo_dq`m')gen lhs_dq`m' = lqshare_dq`m' - loo_dq`m'	}/* 2. Production function estimation------------------------------------------------------------------- *//* a. ACF with exogenous market structure */  save ./tempfiles/data_temp, replace// 1st stagextset fid yr		rename (lemp emp lk k   q p lp uw luw ) (l L k K  Q P p UW uw)		// rename for creating polynomialsgen y = lqgen l_lag = L.lgen k_lag = L.ksave ./tempfiles/data_pf, replacedo ./appendix/china_tobacco_acf_exgexit_stage1.do		// First stage regression // 2nd stagedo ./appendix/china_tobacco_acf_exgexit.do				// Second stage  gen beta_c_acf1 = beta_lin[1,1]gen beta_l_acf1 = beta_lin[2,1]gen beta_k_acf1 = beta_lin[3,1]gen beta_p_acf1 = beta_lin[4,1]gen beta_w_acf1 = beta_lin[5,1]gen scale_acf1 = beta_l_acf1 + beta_k_acf1sum beta*collapse beta* scale*, by(const)			// save the resultssave ./tempfiles/pf_lk_coefs_acf1, replace// Retrieve PF estimates in master programuse ./tempfiles/data_temp, clearmerge m:1 const using ./tempfiles/pf_lk_coefs_acf1, nogen// make residualgen ltfp_acf1 = lq  - beta_l_acf1*lemp - beta_k_acf1*lk - beta_c_acf1	// tfp residual acfgen tfp_acf1=exp(ltfp_acf1) // R^2preservextset fid yrkeep if ltfp_acf1~=.  & L.ltfp_acf1~=.di _Ngen lqhat = beta_l_acf1*lemp + beta_k_acf1*lk + beta_c_acf1 + beta_p_acf1*lp  + beta_w_acf1*luw  egen avlq = mean(lq)gen eps = (lq-lqhat)^2gen var = (lq-avlq)^2collapse(sum) eps vargen r2 = e(r2)gen str4 r2s = string(r2,"%04.2f")local r2 = r2slocal r2_acf1 = substr("`r2'",1,4)drop r2 r2slocal N_acf1 = e(N)restore/* b. ACF with endogenous market structure */xtset fid yrgen dexit = open == 1 & L.open==.replace dexit =1 if open == 1 & L.open==0probit dexit lk lemp lp luw predict px sum pxgen px_lag= L.pxsave ./tempfiles/data_temp, replace// 1st stagextset fid yr		rename (lemp emp lk k   q p lp uw luw ) (l L k K  Q P p UW uw)		// rename for creating polynomialsgen y = lqgen l_lag = L.lgen k_lag = L.ksave ./tempfiles/data_pf, replacedo ./appendix/china_tobacco_acf_endexit_stage1.do		// First stage regression// 2nd stagedo ./appendix/china_tobacco_acf_endexit.do				// Second stagegen beta_c_acf2 = beta_lin[1,1]gen beta_l_acf2 = beta_lin[2,1]gen beta_k_acf2 = beta_lin[3,1]gen beta_p_acf2 = beta_lin[4,1]gen beta_w_acf2 = beta_lin[5,1]gen scale_acf2 = beta_l_acf2 + beta_k_acf2sum beta*collapse beta* scale*, by(const)			// save the resultssave ./tempfiles/pf_lk_coefs_acf2, replace// Retrieve PF estimates in master programuse ./tempfiles/data_temp, clearmerge m:1 const using ./tempfiles/pf_lk_coefs_acf2, nogengen ltfp_acf2 = lq  - beta_l_acf2*lemp - beta_k_acf2*lk - beta_c_acf2	// tfp residual acfgen tfp_acf2=exp(ltfp_acf2) // R^2preservextset fid yrkeep if ltfp_acf1~=.  & L.ltfp_acf1~=.di _Ngen lqhat = beta_l_acf1*lemp + beta_k_acf1*lk + beta_c_acf1 + beta_p_acf1*lp  + beta_w_acf1*luw  egen avlq = mean(lq)gen eps = (lq-lqhat)^2gen var = (lq-avlq)^2collapse(sum) eps vargen r2 = e(r2)gen str4 r2s = string(r2,"%04.2f")local r2 = r2slocal r2_acf2 = substr("`r2'",1,4)drop r2 r2slocal N_acf2 = e(N)restore// save acf results for tableforvalues n = 1/2 { gen bl = beta_l_acf`n'gen bk = beta_k_acf`n'gen scale = scale_acf`n'estpost su bl bk scaleest store pf_acf`n'drop bl bk scale } /* Markdowns */ // Revenue sharesgen alphaL = w/revgen alphaM = m/rev gen dumobs =  lq~=.  & alphaM~=.& alphaL~=. & lemp~=.  & lk~=.sum alphaL alphaM, dforvalues n = 1/2 {gen md_acf`n'= (1/alphaM)*(1-alphaL/beta_l_acf`n')gen mu_acf`n'= 1gen lmu_acf`n' = 0gen lmd_acf`n' = log(md_acf`n')}// store for table forvalues n = 1(1)2 {egen a_md  = mean(md_acf`n') egen m_md  = median(md_acf`n')  estpost su a_md m_md  		// moments in table A4best store md_acf`n' drop a_md m_md }   /* 3. Consolidation treatment effects-----------------------------------------*/ forvalues m = 6(2)6 {forvalues n = 1(1)2 {foreach mod in   "acf" {foreach var in "md"  "tfp" {areg l`var'_`mod'`n'  treat02_dq`m'  post02   yr if dumobs==1 ,   absorb(fid) r 		// results in table A4cgen th_l`var'_`mod'`n'_dq`m'=_b[treat02_dq`m']gen r2 = e(r2)gen str4 r2s = string(r2,"%04.2f")local r2 = r2slocal r2_th_`var'`n' = substr("`r2'",1,4)drop r2 r2slocal N_th_`var'`n' = e(N)}}}} // save results for tablesforeach mod in "acf"  {forvalues n = 1(1)2 {gen th = th_lmd_`mod'`n'_dq6estpost su thest store th_lmd_`mod'`n'_dq6replace th = th_ltfp_`mod'`n'_dq6estpost su thest store th_ltfp_`mod'`n'_dq6drop th }}* Markdown and markup momentsforeach var in "md_acf1" "md_acf2"  {egen _`var' = mean(`var')egen m_`var' = median(`var')global a_`var' = _`var' global m_`var' = m_`var' }drop _m* m_m* sum beta* md* th* /*  Bootstrapping  ----------------------------*/do ./bootstrap/china_tobacco_ap_acf_bs/* Write tables ----------------------------*/     // Production function  gen bl = 1gen bk = 1gen scale = 1label var bl "Output elasticity of labor"label var bk "Output elasticity of capital"label var scale "Scale parameter"esttab pf_acf1 pf_acf1_se pf_acf2 pf_acf2_se   using "/Users/MichaelRubens/Dropbox/China tobacco/Paper/aer_2021_0383/tables/tableA4.tex", replace ///prehead("\textit{panel A: Production function}" &  \multicolumn{2}{c}{Exogenous exit} & \multicolumn{2}{c}{Endogenous exit}   \\ \cline{2-5})   /// mtitle("Est." "S.E." "Est." "S.E." )   ///cells(mean(fmt(3))) label booktabs nonum noobs collabels(none) gaps f    prefoot(\vspace{-0.75em} \\ \vspace{0.25em}   R-squared &  \multicolumn{2}{c}{`r2_acf1'} &  \multicolumn{2}{c}{`r2_acf2'}   ///\vspace{0.25em}  \\ Observations &  \multicolumn{2}{c}{`N_acf1'} &  \multicolumn{2}{c}{`N_acf2'}  \vspace{0.5em} \\  \hline )  posthead( \hline &&&\\   ) drop bl bk scale // Markdowns and markupsgen a_md = 1gen m_md = 1label var a_md "Average markdown"label var m_md "Median markdown"esttab  md_acf1 md_acf1_se md_acf2 md_acf2_se  using "/Users/MichaelRubens/Dropbox/China tobacco/Paper/aer_2021_0383/tables/tableA4.tex", append ///prehead( "\textit{panel B: Markdown moments}"    &  \multicolumn{2}{c}{Exogenous exit} &  \multicolumn{2}{c}{Endogenous exit}  \\ \cline{2-5})   /// mtitle("Est." "S.E." "Est." "S.E."   )   ///cells(mean(fmt(3))) label booktabs nonum noobs collabels(none) gaps f    prefoot(  &&&  \vspace{-0.5em}  \\ \hline    )  posthead( \hline &&&\\   )  drop a_md m_md// Treatment effectsgen th = 1label var th "Treatment*1(Year $\geq$ 2002)"esttab  th_lmd_acf1_dq6 th_lmd_acf1_dq6_se th_lmd_acf2_dq6 th_lmd_acf2_dq6_se  using "/Users/MichaelRubens/Dropbox/China tobacco/Paper/aer_2021_0383/tables/tableA4.tex", append ///prehead(  "\textit{panel C: Treatment effects on markdowns} "  &  \multicolumn{2}{c}{Exogenous exit} &  \multicolumn{2}{c}{Endogenous exit}  \\ \cline{2-5})   ///mtitle("Est." "S.E." "Est." "S.E."   )   ///cells(mean(fmt(3))) label booktabs nonum noobs collabels(none) gaps f    prefoot(\vspace{-0.75em} \\ \vspace{0.25em}   R-squared &  \multicolumn{2}{c}{`r2_th_md1'} &  \multicolumn{2}{c}{`r2_th_md2'}   \vspace{0.25em}  \\ ///Observations &  \multicolumn{2}{c}{`N_th_md1'} &  \multicolumn{2}{c}{`N_th_md2'}   \vspace{0.5em}  \\ \hline  )  posthead( \hline &&&\\   ) esttab  th_ltfp_acf1_dq6 th_ltfp_acf1_dq6_se th_ltfp_acf2_dq6 th_ltfp_acf2_dq6_se  using "/Users/MichaelRubens/Dropbox/China tobacco/Paper/aer_2021_0383/tables/tableA4.tex", append ///prehead( " \textit{panel D: Treatment effects on TFP}"    &  \multicolumn{2}{c}{Exogenous exit} &  \multicolumn{2}{c}{Endogenous exit}\\ \cline{2-5})   ///mtitle("Est." "S.E." "Est." "S.E."   )   ///cells(mean(fmt(3))) label booktabs nonum noobs collabels(none) gaps f    prefoot(\vspace{-0.75em} \\ \vspace{0.25em}   R-squared &  \multicolumn{2}{c}{`r2_th_tfp1'} &  \multicolumn{2}{c}{`r2_th_tfp2'}   \vspace{0.25em}  \\ ///Observations &  \multicolumn{2}{c}{`N_th_tfp1'} &  \multicolumn{2}{c}{`N_th_tfp2'}   \vspace{0.5em}  \\ \hline )  posthead( \hline &&&\\ ) drop th